<!-- layout.html -->
<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>agentscope.prompt._prompt_optimizer &mdash; AgentScope  文档</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=c9484b72" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=7d86a446"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/translations.js?v=beaddf03"></script>
        <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" > 

          
          
          <a href="../../../index.html" class="icon icon-home">
            AgentScope
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div> <!-- language_selector.html -->
<div class="language-selector">
    <a href="../../../../en/_modules/agentscope/prompt/_prompt_optimizer.html">English</a></li> |
    <a href="../../../../zh_CN/_modules/agentscope/prompt/_prompt_optimizer.html">中文</a></li>
</div> 
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">AgentScope 教程</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/101-agentscope.html">关于AgentScope</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/102-installation.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/103-example.html">快速开始</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/203-model.html">模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/203-stream.html">流式输出</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/206-prompt.html">提示工程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/201-agent.html">Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/205-memory.html">记忆</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/203-parser.html">结果解析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/209-prompt_opt.html">系统提示优化</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/204-service.html">工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/202-pipeline.html">Pipeline和MsgHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/208-distribute.html">分布式</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/209-gui.html">AgentScope Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/210-rag.html">简要介绍AgentScope中的RAG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/105-logging.html">日志</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/207-monitor.html">监控</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/104-usecase.html">样例：狼人杀游戏</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/contribute.html">参与贡献</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">AgentScope API 文档</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.html">agentscope package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.message.html">agentscope.message package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.models.html">agentscope.models package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.agents.html">agentscope.agents package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.memory.html">agentscope.memory package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.parsers.html">agentscope.parsers package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.exception.html">agentscope.exception module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.pipelines.html">agentscope.pipelines package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.service.html">agentscope.service package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.rpc.html">agentscope.rpc package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.server.html">agentscope.server package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.web.html">agentscope.web package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.prompt.html">agentscope.prompt package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agentscope.utils.html">agentscope.utils package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">AgentScope</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">模块代码</a></li>
      <li class="breadcrumb-item active">agentscope.prompt._prompt_optimizer</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>agentscope.prompt._prompt_optimizer 源代码</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;A module that optimize agent system prompt given dialog history.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">agentscope.manager</span> <span class="kn">import</span> <span class="n">ModelManager</span>
<span class="kn">from</span> <span class="nn">agentscope.message</span> <span class="kn">import</span> <span class="n">Msg</span>
<span class="kn">from</span> <span class="nn">agentscope.models</span> <span class="kn">import</span> <span class="n">ModelWrapperBase</span>

<span class="n">_DEFAULT_META_PROMPT_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">You are an excellent Prompt Engineer. Your task is to optimize an Agent&#39;s system prompt by adding notes.</span>

<span class="s2">The original system prompt provided by the user is:</span>
<span class="s2">```</span>
<span class="si">{system_prompt}</span>
<span class="s2">```</span>

<span class="s2">The dialog history of user interaction with the agent is:</span>
<span class="s2">```</span>
<span class="si">{dialog_history}</span>
<span class="s2">```</span>

<span class="s2">Now, you need to:</span>
<span class="s2">1. Determine if the user-agent interaction in the dialog history contains any explicit errors (such as function call errors, failure to adhere to input-output formats), misunderstandings of user intentions, etc.</span>
<span class="s2">2. Conduct a detailed analysis of the reasons for the errors and find solutions corresponding to the errors.</span>
<span class="s2">3. Based on the causes of the errors and user intentions, write one or several notes that can be added after the user’s system prompt in the form of attention notes or example notes to prevent the same mistakes from happening again in the future.</span>

<span class="s2">If the notes to be added include examples, be extremely cautious. If unsure whether the example to add is correct, you may refrain from adding.</span>

<span class="s2">The language of the notes you add should be consistent with the original system prompt provided by the user. For example, if the original system prompt provided by the user is written in Chinese, the notes you add should also be in Chinese; if the original system prompt provided by the user is written in English, the notes you add should also be in English.</span>

<span class="s2">The notes you add should be included within the tag [prompt_note], for example:</span>
<span class="s2">[prompt_note] Please note that the output should only include JSON format [/prompt_note].</span>

<span class="s2">If there are no obvious issues in the dialog history, then no notes need to be added.</span>
<span class="s2">&quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

<span class="n">OPT_PROMPT_TEMPLATE_ZH</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;你是一个优秀的Prompt Engineer，现在你要通过添加note的方式对一个Agent的system prompt进行优化。</span>

<span class="s2">用户提供的原始system prompt是：</span>
<span class="s2">```</span>
<span class="si">{system_prompt}</span>
<span class="s2">```</span>

<span class="s2">用户与之交互的dialog history是：</span>
<span class="s2">```</span>
<span class="si">{dialog_history}</span>
<span class="s2">```</span>

<span class="s2">现在，你要</span>
<span class="s2">1. 判断用户与agent交互的dialog history中，是否包含显式的错误（如函数调用错误、没有遵循输入输出格式），对用户意图的误解等。</span>
<span class="s2">2. 对发生错误的原因进行详细分析，并且寻找对于对应错误的解决方案。</span>
<span class="s2">3. 根据错误原因和用户意图，写一条或几条可以添加在用户system prompt后面的注意事项note，或者exmaple形式的note，使之不要再犯同样的错误。</span>
<span class="s2">如果要添加的note包含example，需要格外小心，如果不确定添加的example是否正确，可以先不添加。</span>
<span class="s2">你添加的note语言与用户提供的原始system prompt一致，即用户提供的原始system prompt是使用中文写的，你添加的note也必须是中文; 如果用户提供的原始system prompt是使用english写的，你添加的note也必须是english。</span>
<span class="s2">你添加的note应该包含在tag [prompt_note]中，例如 [prompt_note] 请注意输出仅包含json格式 [/prompt_note]。如果dialog history没有明显问题，则不需要添加任何note。</span>
<span class="s2">&quot;&quot;&quot;</span>  <span class="c1"># noqa</span>


<div class="viewcode-block" id="SystemPromptOptimizer">
<a class="viewcode-back" href="../../../agentscope.prompt.html#agentscope.prompt.SystemPromptOptimizer">[文档]</a>
<span class="k">class</span> <span class="nc">SystemPromptOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A system prompt optimizer class. For now (2024-06-13), the optimizer can</span>
<span class="sd">    optimize system prompt by extracting notes from the dialog history. It&#39;s</span>
<span class="sd">    more like reflection on the dialog history.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SystemPromptOptimizer.__init__">
<a class="viewcode-back" href="../../../agentscope.prompt.html#agentscope.prompt.SystemPromptOptimizer.__init__">[文档]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_or_model_config_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ModelWrapperBase</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">meta_prompt_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_DEFAULT_META_PROMPT_TEMPLATE</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the system prompt optimizer.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_or_model_config_name (`Union[ModelWrapperBase, str]`):</span>
<span class="sd">                The model or model config name to be used for generating notes.</span>
<span class="sd">            meta_prompt_template (`str`,</span>
<span class="sd">            defaults to `_DEFAULT_META_PROMPT_TEMPLATE`):</span>
<span class="sd">                The meta prompt to guide the LLM to extract notes from the</span>
<span class="sd">                system prompt and dialog history. Must contain placeholders</span>
<span class="sd">                `{system_prompt}` and `{dialog_history}`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_model_config_name</span><span class="p">,</span> <span class="n">ModelWrapperBase</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_or_model_config_name</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_model_config_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">model_manager</span> <span class="o">=</span> <span class="n">ModelManager</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_manager</span><span class="o">.</span><span class="n">get_model_by_config_name</span><span class="p">(</span>
                <span class="n">model_or_model_config_name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;model_or_model_config_name must be ModelWrapperBase or str&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meta_prompt</span> <span class="o">=</span> <span class="n">meta_prompt_template</span></div>


    <span class="k">def</span> <span class="nf">_get_all_tagged_notes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all the notes in the response text.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Use a parser to extract the notes</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_tag</span> <span class="o">=</span> <span class="s2">&quot;[prompt_note]&quot;</span>
        <span class="n">end_tag</span> <span class="o">=</span> <span class="s2">&quot;[/prompt_note]&quot;</span>
        <span class="n">start_index</span> <span class="o">=</span> <span class="n">response_text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">start_tag</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">start_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">end_index</span> <span class="o">=</span> <span class="n">response_text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                <span class="n">end_tag</span><span class="p">,</span>
                <span class="n">start_index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_tag</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">end_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">note</span> <span class="o">=</span> <span class="n">response_text</span><span class="p">[</span><span class="n">start_index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_tag</span><span class="p">)</span> <span class="p">:</span> <span class="n">end_index</span><span class="p">]</span>
                <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
                <span class="n">start_index</span> <span class="o">=</span> <span class="n">response_text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                    <span class="n">start_tag</span><span class="p">,</span>
                    <span class="n">end_index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_tag</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">notes</span>

<div class="viewcode-block" id="SystemPromptOptimizer.generate_notes">
<a class="viewcode-back" href="../../../agentscope.prompt.html#agentscope.prompt.SystemPromptOptimizer.generate_notes">[文档]</a>
    <span class="k">def</span> <span class="nf">generate_notes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">dialog_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Msg</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given the system prompt and conversation history, generate notes to</span>
<span class="sd">        optimize the system prompt.</span>

<span class="sd">        Args:</span>
<span class="sd">            system_prompt (`str`):</span>
<span class="sd">                The system prompt provided by the user.</span>
<span class="sd">            dialog_history (`List[Msg]`):</span>
<span class="sd">                The conversation history of user interaction with the agent.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: The notes added to the system prompt.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dialog_history_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">dialog_history</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">Msg</span><span class="p">(</span>
                <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta_prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
                    <span class="n">dialog_history</span><span class="o">=</span><span class="n">dialog_history_str</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>

        <span class="c1"># Extract all the notes from the response text</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_tagged_notes</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">notes</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2024, Alibaba Tongyi Lab。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>